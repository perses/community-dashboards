kind: Dashboard
metadata:
    name: tempo-rollout-progress-overview
    createdAt: 0001-01-01T00:00:00Z
    updatedAt: 0001-01-01T00:00:00Z
    version: 0
    project: perses-dev
spec:
    display:
        name: Tempo / Rollout progress
    variables:
        - kind: ListVariable
          spec:
            display:
                name: cluster
                hidden: false
            allowAllValue: false
            allowMultiple: true
            plugin:
                kind: PrometheusLabelValuesVariable
                spec:
                    datasource:
                        kind: PrometheusDatasource
                        name: prometheus-datasource
                    labelName: cluster
                    matchers:
                        - tempo_build_info{}
            name: cluster
        - kind: ListVariable
          spec:
            display:
                name: namespace
                hidden: false
            allowAllValue: false
            allowMultiple: false
            plugin:
                kind: PrometheusLabelValuesVariable
                spec:
                    datasource:
                        kind: PrometheusDatasource
                        name: prometheus-datasource
                    labelName: namespace
                    matchers:
                        - tempo_build_info{cluster="$cluster"}
            name: namespace
    panels:
        "0_0":
            kind: Panel
            spec:
                display:
                    name: Rollout progress
                    description: Shows progress of Tempo deployment
                plugin:
                    kind: BarChart
                    spec:
                        calculation: last
                        format:
                            unit: percent
                        mode: percentage
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      (
                                          sum by (tempo_service) (
                                            label_replace(
                                              kube_statefulset_status_replicas_updated{cluster=~"$cluster",namespace=~"$namespace",statefulset=~".*(cortex-gw|distributor|ingester|query-frontend|querier|compactor|metrics-generator).*"},
                                              "tempo_service",
                                              "$1",
                                              "statefulset",
                                              "(.*?)(?:-zone-[a-z])?"
                                            )
                                          )
                                        /
                                          sum by (tempo_service) (
                                            label_replace(
                                              kube_statefulset_replicas{cluster=~"$cluster",namespace=~"$namespace"},
                                              "tempo_service",
                                              "$1",
                                              "statefulset",
                                              "(.*?)(?:-zone-[a-z])?"
                                            )
                                          )
                                      )
                                    and
                                      (
                                          sum by (tempo_service) (
                                            label_replace(
                                              kube_statefulset_replicas{cluster=~"$cluster",namespace=~"$namespace"},
                                              "tempo_service",
                                              "$1",
                                              "statefulset",
                                              "(.*?)(?:-zone-[a-z])?"
                                            )
                                          )
                                        >
                                          0
                                      )
                                seriesNameFormat: '{{tempo_service}}'
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      (
                                          sum by (tempo_service) (
                                            label_replace(
                                              kube_deployment_status_replicas_updated{cluster=~"$cluster",deployment=~".*(cortex-gw|distributor|ingester|query-frontend|querier|compactor|metrics-generator).*",namespace=~"$namespace"},
                                              "tempo_service",
                                              "$1",
                                              "deployment",
                                              "(.*?)(?:-zone-[a-z])?"
                                            )
                                          )
                                        /
                                          sum by (tempo_service) (
                                            label_replace(
                                              kube_deployment_spec_replicas{cluster=~"$cluster",namespace=~"$namespace"},
                                              "tempo_service",
                                              "$1",
                                              "deployment",
                                              "(.*?)(?:-zone-[a-z])?"
                                            )
                                          )
                                      )
                                    and
                                      (
                                          sum by (tempo_service) (
                                            label_replace(
                                              kube_deployment_spec_replicas{cluster=~"$cluster",namespace=~"$namespace"},
                                              "tempo_service",
                                              "$1",
                                              "deployment",
                                              "(.*?)(?:-zone-[a-z])?"
                                            )
                                          )
                                        >
                                          0
                                      )
                                seriesNameFormat: '{{tempo_service}}'
        "1_0":
            kind: Panel
            spec:
                display:
                    name: Writes - 2xx
                    description: Success ratio of trace requests handled by Tempo
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: percent-decimal
                        sparkline:
                            width: 1
                        valueFontSize: 50
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      sum(
                                        rate(
                                          tempo_request_duration_seconds_count{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"(opentelemetry_proto_collector_trace_v1_traceservice_export|otlp_v1_traces)",status_code=~"2.+"}[$__rate_interval]
                                        )
                                      )
                                    /
                                      sum(
                                        rate(
                                          tempo_request_duration_seconds_count{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"(opentelemetry_proto_collector_trace_v1_traceservice_export|otlp_v1_traces)"}[$__rate_interval]
                                        )
                                      )
        "1_1":
            kind: Panel
            spec:
                display:
                    name: Writes - 4xx
                    description: Ratio of trace requests errors of the request handled by Tempo
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: percent-decimal
                        sparkline:
                            width: 1
                        valueFontSize: 50
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      sum(
                                        rate(
                                          tempo_request_duration_seconds_count{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"(opentelemetry_proto_collector_trace_v1_traceservice_export|otlp_v1_traces)",status_code=~"4.+"}[$__rate_interval]
                                        )
                                      )
                                    /
                                      sum(
                                        rate(
                                          tempo_request_duration_seconds_count{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"(opentelemetry_proto_collector_trace_v1_traceservice_export|otlp_v1_traces)"}[$__rate_interval]
                                        )
                                      )
        "1_2":
            kind: Panel
            spec:
                display:
                    name: Writes - 5xx
                    description: Server error rate of the request handled by Tempo
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: percent-decimal
                        sparkline:
                            width: 1
                        valueFontSize: 50
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      sum(
                                        rate(
                                          tempo_request_duration_seconds_count{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"(opentelemetry_proto_collector_trace_v1_traceservice_export|otlp_v1_traces)",status_code=~"5.+"}[$__rate_interval]
                                        )
                                      )
                                    /
                                      sum(
                                        rate(
                                          tempo_request_duration_seconds_count{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"(opentelemetry_proto_collector_trace_v1_traceservice_export|otlp_v1_traces)"}[$__rate_interval]
                                        )
                                      )
        "1_3":
            kind: Panel
            spec:
                display:
                    name: Writes 99th latency
                    description: Shows the 99th quantile latency for Tempo
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: seconds
                        thresholds:
                            mode: absolute
                            defaultColor: green
                            steps:
                                - value: 0.2
                                  color: orange
                                - value: 0.5
                                  color: red
                        sparkline:
                            width: 1
                        valueFontSize: 50
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    histogram_quantile(
                                      0.99,
                                      sum by (le) (
                                        tempo_request_duration_seconds_bucket{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"(opentelemetry_proto_collector_trace_v1_traceservice_export|otlp_v1_traces)"}
                                      )
                                    )
        "2_0":
            kind: Panel
            spec:
                display:
                    name: Reads - 2xx
                    description: Success ratio of trace requests handled by Tempo
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: percent-decimal
                        sparkline:
                            width: 1
                        valueFontSize: 50
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      sum(
                                        rate(
                                          tempo_request_duration_seconds_count{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"tempo_api_.*",status_code=~"2.+"}[$__rate_interval]
                                        )
                                      )
                                    /
                                      sum(
                                        rate(
                                          tempo_request_duration_seconds_count{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"tempo_api_.*"}[$__rate_interval]
                                        )
                                      )
        "2_1":
            kind: Panel
            spec:
                display:
                    name: Reads - 4xx
                    description: Ratio of trace requests errors of the request handled by Tempo
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: percent-decimal
                        sparkline:
                            width: 1
                        valueFontSize: 50
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      sum(
                                        rate(
                                          tempo_request_duration_seconds_count{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"tempo_api_.*",status_code=~"4.+"}[$__rate_interval]
                                        )
                                      )
                                    /
                                      sum(
                                        rate(
                                          tempo_request_duration_seconds_count{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"tempo_api_.*"}[$__rate_interval]
                                        )
                                      )
        "2_2":
            kind: Panel
            spec:
                display:
                    name: Reads - 5xx
                    description: Server error rate of the request handled by Tempo
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: percent-decimal
                        sparkline:
                            width: 1
                        valueFontSize: 50
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      sum(
                                        rate(
                                          tempo_request_duration_seconds_count{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"tempo_api_.*",status_code=~"5.+"}[$__rate_interval]
                                        )
                                      )
                                    /
                                      sum(
                                        rate(
                                          tempo_request_duration_seconds_count{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"tempo_api_.*"}[$__rate_interval]
                                        )
                                      )
        "2_3":
            kind: Panel
            spec:
                display:
                    name: Writes 99th latency
                    description: Shows the 99th quantile latency for Tempo
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: seconds
                        thresholds:
                            mode: absolute
                            defaultColor: green
                            steps:
                                - value: 1
                                  color: orange
                                - value: 2.5
                                  color: red
                        sparkline:
                            width: 1
                        valueFontSize: 50
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    histogram_quantile(
                                      0.99,
                                      sum by (le) (
                                        tempo_request_duration_seconds_bucket{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"tempo_api_.*"}
                                      )
                                    )
        "3_0":
            kind: Panel
            spec:
                display:
                    name: Unhealthy pods
                    description: Shows the status of Tempo deployment
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        legend:
                            position: bottom
                            mode: table
                        yAxis:
                            format:
                                unit: decimal
                        visual:
                            display: line
                            lineWidth: 0.25
                            areaOpacity: 1
                            palette:
                                mode: auto
                            stack: all
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      kube_deployment_status_replicas_unavailable{cluster=~"$cluster",deployment=~".*(cortex-gw|distributor|ingester|query-frontend|querier|compactor|metrics-generator).*",namespace=~"$namespace"}
                                    >
                                      0
                                seriesNameFormat: '{{deployment}}'
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                        kube_statefulset_status_replicas_current{cluster=~"$cluster",namespace=~"$namespace",statefulset=~".*(cortex-gw|distributor|ingester|query-frontend|querier|compactor|metrics-generator).*"}
                                      -
                                        kube_statefulset_status_replicas_ready{cluster=~"$cluster",namespace=~"$namespace",statefulset=~".*(cortex-gw|distributor|ingester|query-frontend|querier|compactor|metrics-generator).*"}
                                    >
                                      0
                                seriesNameFormat: '{{statefulset}}'
        "3_1":
            kind: Panel
            spec:
                display:
                    name: Pods count per version
                    description: Table with the count of tempo pods by version
                plugin:
                    kind: Table
                    spec:
                        columnSettings:
                            - name: container
                              header: Container
                              align: left
                            - name: version
                              header: Version
                              align: left
                            - name: value
                              header: number of pods
                              align: right
                            - name: timestamp
                              hide: true
                        transforms:
                            - kind: MergeSeries
                              spec: {}
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    count by (container, version) (
                                      label_replace(
                                        kube_pod_container_info{cluster=~"$cluster",container=~".*(cortex-gw|distributor|ingester|query-frontend|querier|compactor|metrics-generator).*",namespace=~"$namespace"},
                                        "version",
                                        "$1",
                                        "image",
                                        ".*:(.+)-.*"
                                      )
                                    )
        "3_2":
            kind: Panel
            spec:
                display:
                    name: Latency vs 24h ago
                    description: Shows the 99th quantile latency of Tempo Read and Writes.
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        legend:
                            position: bottom
                            mode: list
                            size: small
                        yAxis:
                            format:
                                unit: milliseconds
                        visual:
                            display: line
                            lineWidth: 0.25
                            areaOpacity: 0.5
                            palette:
                                mode: auto
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      1
                                    -
                                      (
                                          avg_over_time(
                                            histogram_quantile(
                                              0.99,
                                              sum by (le) (
                                                tempo_request_duration_seconds_bucket{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"(opentelemetry_proto_collector_trace_v1_traceservice_export|otlp_v1_traces)"} offset 1d
                                              )
                                            )[1h:]
                                          )
                                        /
                                          avg_over_time(
                                            histogram_quantile(
                                              0.99,
                                              sum by (le) (
                                                tempo_request_duration_seconds_bucket{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"(opentelemetry_proto_collector_trace_v1_traceservice_export|otlp_v1_traces)"}
                                              )
                                            )[1h:]
                                          )
                                      )
                                seriesNameFormat: writes
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      1
                                    -
                                      (
                                          avg_over_time(
                                            histogram_quantile(
                                              0.99,
                                              sum by (le) (
                                                tempo_request_duration_seconds_bucket{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"tempo_api_.*"} offset 1d
                                              )
                                            )[1h:]
                                          )
                                        /
                                          avg_over_time(
                                            histogram_quantile(
                                              0.99,
                                              sum by (le) (
                                                tempo_request_duration_seconds_bucket{cluster=~"$cluster",job=~"($namespace)/cortex-gw(-internal)?",route=~"tempo_api_.*"}
                                              )
                                            )[1h:]
                                          )
                                      )
                                seriesNameFormat: reads
    layouts:
        - kind: Grid
          spec:
            display:
                title: Rollout progress
            items:
                - x: 0
                  "y": 0
                  width: 24
                  height: 8
                  content:
                    $ref: '#/spec/panels/0_0'
        - kind: Grid
          spec:
            display:
                title: Tempo Writes stats
            items:
                - x: 0
                  "y": 0
                  width: 6
                  height: 8
                  content:
                    $ref: '#/spec/panels/1_0'
                - x: 6
                  "y": 0
                  width: 6
                  height: 8
                  content:
                    $ref: '#/spec/panels/1_1'
                - x: 12
                  "y": 0
                  width: 6
                  height: 8
                  content:
                    $ref: '#/spec/panels/1_2'
                - x: 18
                  "y": 0
                  width: 6
                  height: 8
                  content:
                    $ref: '#/spec/panels/1_3'
        - kind: Grid
          spec:
            display:
                title: Tempo Reads stats
            items:
                - x: 0
                  "y": 0
                  width: 6
                  height: 8
                  content:
                    $ref: '#/spec/panels/2_0'
                - x: 6
                  "y": 0
                  width: 6
                  height: 8
                  content:
                    $ref: '#/spec/panels/2_1'
                - x: 12
                  "y": 0
                  width: 6
                  height: 8
                  content:
                    $ref: '#/spec/panels/2_2'
                - x: 18
                  "y": 0
                  width: 6
                  height: 8
                  content:
                    $ref: '#/spec/panels/2_3'
        - kind: Grid
          spec:
            display:
                title: Tempo Pods
            items:
                - x: 0
                  "y": 0
                  width: 8
                  height: 8
                  content:
                    $ref: '#/spec/panels/3_0'
                - x: 8
                  "y": 0
                  width: 8
                  height: 8
                  content:
                    $ref: '#/spec/panels/3_1'
                - x: 16
                  "y": 0
                  width: 8
                  height: 8
                  content:
                    $ref: '#/spec/panels/3_2'
    duration: 1h
